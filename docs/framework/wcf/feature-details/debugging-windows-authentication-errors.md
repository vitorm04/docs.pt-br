---
title: Depurando erros de autenticação do Windows
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
helpviewer_keywords:
- WCF, authentication
- WCF, Windows authentication
ms.assetid: 181be4bd-79b1-4a66-aee2-931887a6d7cc
ms.openlocfilehash: 52e968706ef4ca703a26e613e681cff3c30ba181
ms.sourcegitcommit: a4f9b754059f0210e29ae0578363a27b9ba84b64
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 12/05/2019
ms.locfileid: "74838020"
---
# <a name="debugging-windows-authentication-errors"></a><span data-ttu-id="92c6f-102">Depurando erros de autenticação do Windows</span><span class="sxs-lookup"><span data-stu-id="92c6f-102">Debugging Windows Authentication Errors</span></span>
<span data-ttu-id="92c6f-103">Ao usar a autenticação do Windows como um mecanismo de segurança, a interface de provedor de suporte de segurança (SSPI) lida com processos de segurança.</span><span class="sxs-lookup"><span data-stu-id="92c6f-103">When using Windows authentication as a security mechanism, the Security Support Provider Interface (SSPI) handles security processes.</span></span> <span data-ttu-id="92c6f-104">Quando ocorrem erros de segurança na camada SSPI, eles são exibidos por Windows Communication Foundation (WCF).</span><span class="sxs-lookup"><span data-stu-id="92c6f-104">When security errors occur at the SSPI layer, they are surfaced by Windows Communication Foundation (WCF).</span></span> <span data-ttu-id="92c6f-105">Este tópico fornece uma estrutura e um conjunto de perguntas para ajudar a diagnosticar os erros.</span><span class="sxs-lookup"><span data-stu-id="92c6f-105">This topic provides a framework and set of questions to help diagnose the errors.</span></span>  
  
 <span data-ttu-id="92c6f-106">Para obter uma visão geral do protocolo Kerberos, consulte [Kerberos explicou](https://go.microsoft.com/fwlink/?LinkID=86946); para obter uma visão geral do SSPI, consulte [SSPI](https://go.microsoft.com/fwlink/?LinkId=88941).</span><span class="sxs-lookup"><span data-stu-id="92c6f-106">For an overview of the Kerberos protocol, see [Kerberos Explained](https://go.microsoft.com/fwlink/?LinkID=86946); for an overview of SSPI, see [SSPI](https://go.microsoft.com/fwlink/?LinkId=88941).</span></span>  
  
 <span data-ttu-id="92c6f-107">Para a autenticação do Windows, o WCF normalmente usa o SSP ( *Negotiate* Security Support Provider), que executa a autenticação mútua do Kerberos entre o cliente e o serviço.</span><span class="sxs-lookup"><span data-stu-id="92c6f-107">For Windows authentication, WCF typically uses the *Negotiate* Security Support Provider (SSP), which performs Kerberos mutual authentication between the client and service.</span></span> <span data-ttu-id="92c6f-108">Se o protocolo Kerberos não estiver disponível, por padrão, o WCF retornará ao NT LAN Manager (NTLM).</span><span class="sxs-lookup"><span data-stu-id="92c6f-108">If the Kerberos protocol is not available, by default WCF falls back to NT LAN Manager (NTLM).</span></span> <span data-ttu-id="92c6f-109">No entanto, você pode configurar o WCF para usar apenas o protocolo Kerberos (e para gerar uma exceção se o Kerberos não estiver disponível).</span><span class="sxs-lookup"><span data-stu-id="92c6f-109">However, you can configure WCF to use only the Kerberos protocol (and to throw an exception if Kerberos is not available).</span></span> <span data-ttu-id="92c6f-110">Você também pode configurar o WCF para usar formulários restritos do protocolo Kerberos.</span><span class="sxs-lookup"><span data-stu-id="92c6f-110">You can also configure WCF to use restricted forms of the Kerberos protocol.</span></span>  
  
## <a name="debugging-methodology"></a><span data-ttu-id="92c6f-111">Metodologia de depuração</span><span class="sxs-lookup"><span data-stu-id="92c6f-111">Debugging Methodology</span></span>  
 <span data-ttu-id="92c6f-112">O método básico é o seguinte:</span><span class="sxs-lookup"><span data-stu-id="92c6f-112">The basic method is as follows:</span></span>  
  
1. <span data-ttu-id="92c6f-113">Determine se você está usando a autenticação do Windows.</span><span class="sxs-lookup"><span data-stu-id="92c6f-113">Determine whether you are using Windows authentication.</span></span> <span data-ttu-id="92c6f-114">Se você estiver usando qualquer outro esquema, este tópico não se aplicará.</span><span class="sxs-lookup"><span data-stu-id="92c6f-114">If you are using any other scheme, this topic does not apply.</span></span>  
  
2. <span data-ttu-id="92c6f-115">Se você tiver certeza de que está usando a autenticação do Windows, determine se a configuração do WCF usa Kerberos Direct ou Negotiate.</span><span class="sxs-lookup"><span data-stu-id="92c6f-115">If you are sure you are using Windows authentication, determine whether your WCF configuration uses Kerberos direct or Negotiate.</span></span>  
  
3. <span data-ttu-id="92c6f-116">Depois de determinar se sua configuração está usando o protocolo Kerberos ou NTLM, você pode entender as mensagens de erro no contexto correto.</span><span class="sxs-lookup"><span data-stu-id="92c6f-116">Once you have determined whether your configuration is using the Kerberos protocol or NTLM, you can understand error messages in the correct context.</span></span>  
  
### <a name="availability-of-the-kerberos-protocol-and-ntlm"></a><span data-ttu-id="92c6f-117">Disponibilidade do protocolo Kerberos e NTLM</span><span class="sxs-lookup"><span data-stu-id="92c6f-117">Availability of the Kerberos Protocol and NTLM</span></span>  
 <span data-ttu-id="92c6f-118">O SSP do Kerberos requer um controlador de domínio para atuar como o centro de distribuição de chaves do Kerberos (KDC).</span><span class="sxs-lookup"><span data-stu-id="92c6f-118">The Kerberos SSP requires a domain controller to act as the Kerberos Key Distribution Center (KDC).</span></span> <span data-ttu-id="92c6f-119">O protocolo Kerberos está disponível somente quando o cliente e o serviço estão usando identidades de domínio.</span><span class="sxs-lookup"><span data-stu-id="92c6f-119">The Kerberos protocol is available only when both the client and service are using domain identities.</span></span> <span data-ttu-id="92c6f-120">Em outras combinações de conta, o NTLM é usado, conforme resumido na tabela a seguir.</span><span class="sxs-lookup"><span data-stu-id="92c6f-120">In other account combinations, NTLM is used, as summarized in the following table.</span></span>  
  
 <span data-ttu-id="92c6f-121">Os cabeçalhos de tabela mostram possíveis tipos de conta usados pelo servidor.</span><span class="sxs-lookup"><span data-stu-id="92c6f-121">The table headers show possible account types used by the server.</span></span> <span data-ttu-id="92c6f-122">A coluna à esquerda mostra os possíveis tipos de conta usados pelo cliente.</span><span class="sxs-lookup"><span data-stu-id="92c6f-122">The left column shows possible account types used by the client.</span></span>  
  
||<span data-ttu-id="92c6f-123">Usuário local</span><span class="sxs-lookup"><span data-stu-id="92c6f-123">Local User</span></span>|<span data-ttu-id="92c6f-124">Sistema Local</span><span class="sxs-lookup"><span data-stu-id="92c6f-124">Local System</span></span>|<span data-ttu-id="92c6f-125">Usuário de domínio</span><span class="sxs-lookup"><span data-stu-id="92c6f-125">Domain User</span></span>|<span data-ttu-id="92c6f-126">Computador de domínio</span><span class="sxs-lookup"><span data-stu-id="92c6f-126">Domain Machine</span></span>|  
|-|----------------|------------------|-----------------|--------------------|  
|<span data-ttu-id="92c6f-127">Usuário local</span><span class="sxs-lookup"><span data-stu-id="92c6f-127">Local User</span></span>|<span data-ttu-id="92c6f-128">NTLM</span><span class="sxs-lookup"><span data-stu-id="92c6f-128">NTLM</span></span>|<span data-ttu-id="92c6f-129">NTLM</span><span class="sxs-lookup"><span data-stu-id="92c6f-129">NTLM</span></span>|<span data-ttu-id="92c6f-130">NTLM</span><span class="sxs-lookup"><span data-stu-id="92c6f-130">NTLM</span></span>|<span data-ttu-id="92c6f-131">NTLM</span><span class="sxs-lookup"><span data-stu-id="92c6f-131">NTLM</span></span>|  
|<span data-ttu-id="92c6f-132">Sistema Local</span><span class="sxs-lookup"><span data-stu-id="92c6f-132">Local System</span></span>|<span data-ttu-id="92c6f-133">NTLM anônima</span><span class="sxs-lookup"><span data-stu-id="92c6f-133">Anonymous NTLM</span></span>|<span data-ttu-id="92c6f-134">NTLM anônima</span><span class="sxs-lookup"><span data-stu-id="92c6f-134">Anonymous NTLM</span></span>|<span data-ttu-id="92c6f-135">NTLM anônima</span><span class="sxs-lookup"><span data-stu-id="92c6f-135">Anonymous NTLM</span></span>|<span data-ttu-id="92c6f-136">NTLM anônima</span><span class="sxs-lookup"><span data-stu-id="92c6f-136">Anonymous NTLM</span></span>|  
|<span data-ttu-id="92c6f-137">Usuário de domínio</span><span class="sxs-lookup"><span data-stu-id="92c6f-137">Domain User</span></span>|<span data-ttu-id="92c6f-138">NTLM</span><span class="sxs-lookup"><span data-stu-id="92c6f-138">NTLM</span></span>|<span data-ttu-id="92c6f-139">NTLM</span><span class="sxs-lookup"><span data-stu-id="92c6f-139">NTLM</span></span>|<span data-ttu-id="92c6f-140">Kerberos</span><span class="sxs-lookup"><span data-stu-id="92c6f-140">Kerberos</span></span>|<span data-ttu-id="92c6f-141">Kerberos</span><span class="sxs-lookup"><span data-stu-id="92c6f-141">Kerberos</span></span>|  
|<span data-ttu-id="92c6f-142">Computador de domínio</span><span class="sxs-lookup"><span data-stu-id="92c6f-142">Domain Machine</span></span>|<span data-ttu-id="92c6f-143">NTLM</span><span class="sxs-lookup"><span data-stu-id="92c6f-143">NTLM</span></span>|<span data-ttu-id="92c6f-144">NTLM</span><span class="sxs-lookup"><span data-stu-id="92c6f-144">NTLM</span></span>|<span data-ttu-id="92c6f-145">Kerberos</span><span class="sxs-lookup"><span data-stu-id="92c6f-145">Kerberos</span></span>|<span data-ttu-id="92c6f-146">Kerberos</span><span class="sxs-lookup"><span data-stu-id="92c6f-146">Kerberos</span></span>|  
  
 <span data-ttu-id="92c6f-147">Especificamente, os quatro tipos de conta incluem:</span><span class="sxs-lookup"><span data-stu-id="92c6f-147">Specifically, the four account types include:</span></span>  
  
- <span data-ttu-id="92c6f-148">Usuário local: perfil de usuário somente máquina.</span><span class="sxs-lookup"><span data-stu-id="92c6f-148">Local User: Machine-only user profile.</span></span> <span data-ttu-id="92c6f-149">Por exemplo `MachineName\Administrator` ou `MachineName\ProfileName`.</span><span class="sxs-lookup"><span data-stu-id="92c6f-149">For example: `MachineName\Administrator` or `MachineName\ProfileName`.</span></span>  
  
- <span data-ttu-id="92c6f-150">Sistema local: o sistema de conta interno em um computador que não está ingressado em um domínio.</span><span class="sxs-lookup"><span data-stu-id="92c6f-150">Local System: The built-in account SYSTEM on a machine that is not joined to a domain.</span></span>  
  
- <span data-ttu-id="92c6f-151">Usuário de domínio: uma conta de usuário em um domínio do Windows.</span><span class="sxs-lookup"><span data-stu-id="92c6f-151">Domain User: A user account on a Windows domain.</span></span> <span data-ttu-id="92c6f-152">Por exemplo: `DomainName\ProfileName`.</span><span class="sxs-lookup"><span data-stu-id="92c6f-152">For example: `DomainName\ProfileName`.</span></span>  
  
- <span data-ttu-id="92c6f-153">Computador de domínio: um processo com a identidade do computador em execução em um computador ingressado em um domínio do Windows.</span><span class="sxs-lookup"><span data-stu-id="92c6f-153">Domain Machine: A process with machine identity running on a machine joined to a Windows domain.</span></span> <span data-ttu-id="92c6f-154">Por exemplo: `MachineName\Network Service`.</span><span class="sxs-lookup"><span data-stu-id="92c6f-154">For example: `MachineName\Network Service`.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="92c6f-155">A credencial de serviço é capturada quando o método <xref:System.ServiceModel.ICommunicationObject.Open%2A> da classe <xref:System.ServiceModel.ServiceHost> é chamado.</span><span class="sxs-lookup"><span data-stu-id="92c6f-155">The service credential is captured when the <xref:System.ServiceModel.ICommunicationObject.Open%2A> method of the <xref:System.ServiceModel.ServiceHost> class is called.</span></span> <span data-ttu-id="92c6f-156">A credencial do cliente é lida sempre que o cliente envia uma mensagem.</span><span class="sxs-lookup"><span data-stu-id="92c6f-156">The client credential is read whenever the client sends a message.</span></span>  
  
## <a name="common-windows-authentication-problems"></a><span data-ttu-id="92c6f-157">Problemas comuns de autenticação do Windows</span><span class="sxs-lookup"><span data-stu-id="92c6f-157">Common Windows Authentication Problems</span></span>  
 <span data-ttu-id="92c6f-158">Esta seção aborda alguns problemas comuns de autenticação do Windows e possíveis soluções.</span><span class="sxs-lookup"><span data-stu-id="92c6f-158">This section discusses some common Windows authentication problems and possible remedies.</span></span>  
  
### <a name="kerberos-protocol"></a><span data-ttu-id="92c6f-159">Protocolo Kerberos</span><span class="sxs-lookup"><span data-stu-id="92c6f-159">Kerberos Protocol</span></span>  
  
#### <a name="spnupn-problems-with-the-kerberos-protocol"></a><span data-ttu-id="92c6f-160">Problemas de SPN/UPN com o protocolo Kerberos</span><span class="sxs-lookup"><span data-stu-id="92c6f-160">SPN/UPN Problems with the Kerberos Protocol</span></span>  
 <span data-ttu-id="92c6f-161">Ao usar a autenticação do Windows e o protocolo Kerberos é usado ou negociado por SSPI, a URL usada pelo ponto de extremidade do cliente deve incluir o nome de domínio totalmente qualificado do host do serviço dentro da URL do serviço.</span><span class="sxs-lookup"><span data-stu-id="92c6f-161">When using Windows authentication, and the Kerberos protocol is used or negotiated by SSPI, the URL the client endpoint uses must include the fully qualified domain name of the service's host inside the service URL.</span></span> <span data-ttu-id="92c6f-162">Isso pressupõe que a conta na qual o serviço está sendo executado tenha acesso à chave SPN (nome da entidade de serviço) do computador que é criada quando o computador é adicionado ao domínio Active Directory, que é mais comumente feito pela execução do serviço no Conta de serviço de rede.</span><span class="sxs-lookup"><span data-stu-id="92c6f-162">This assumes that the account under which the service is running has access to the machine (default) service principal name (SPN) key that is created when the computer is added to the Active Directory domain, which is most commonly done by running the service under the Network Service account.</span></span> <span data-ttu-id="92c6f-163">Se o serviço não tiver acesso à chave de SPN do computador, você deverá fornecer o SPN ou nome UPN correto da conta sob a qual o serviço está sendo executado na identidade do ponto de extremidade do cliente.</span><span class="sxs-lookup"><span data-stu-id="92c6f-163">If the service does not have access to the machine SPN key, you must supply the correct SPN or user principal name (UPN) of the account under which the service is running in the client's endpoint identity.</span></span> <span data-ttu-id="92c6f-164">Para obter mais informações sobre como o WCF funciona com o SPN e o UPN, consulte [identidade de serviço e autenticação](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md).</span><span class="sxs-lookup"><span data-stu-id="92c6f-164">For more information about how WCF works with SPN and UPN, see [Service Identity and Authentication](../../../../docs/framework/wcf/feature-details/service-identity-and-authentication.md).</span></span>  
  
 <span data-ttu-id="92c6f-165">Em cenários de balanceamento de carga, como Web farms ou ambientes Web, uma prática comum é definir uma conta exclusiva para cada aplicativo, atribuir um SPN a essa conta e garantir que todos os serviços do aplicativo sejam executados nessa conta.</span><span class="sxs-lookup"><span data-stu-id="92c6f-165">In load-balancing scenarios, such as Web farms or Web gardens, a common practice is to define a unique account for each application, assign an SPN to that account, and ensure that all of the application's services run in that account.</span></span>  
  
 <span data-ttu-id="92c6f-166">Para obter um SPN para a conta de seu serviço, você precisa ser um administrador de domínio Active Directory.</span><span class="sxs-lookup"><span data-stu-id="92c6f-166">To obtain an SPN for your service's account, you need to be an Active Directory domain administrator.</span></span> <span data-ttu-id="92c6f-167">Para obter mais informações, consulte [complemento técnico do Kerberos para Windows](https://go.microsoft.com/fwlink/?LinkID=88330).</span><span class="sxs-lookup"><span data-stu-id="92c6f-167">For more information, see [Kerberos Technical Supplement for Windows](https://go.microsoft.com/fwlink/?LinkID=88330).</span></span>  
  
#### <a name="kerberos-protocol-direct-requires-the-service-to-run-under-a-domain-machine-account"></a><span data-ttu-id="92c6f-168">O protocolo Kerberos direto requer que o serviço seja executado em uma conta de computador de domínio</span><span class="sxs-lookup"><span data-stu-id="92c6f-168">Kerberos Protocol Direct Requires the Service to Run Under a Domain Machine Account</span></span>  
 <span data-ttu-id="92c6f-169">Isso ocorre quando a propriedade `ClientCredentialType` é definida como `Windows` e a propriedade <xref:System.ServiceModel.MessageSecurityOverHttp.NegotiateServiceCredential%2A> é definida como `false`, conforme mostrado no código a seguir.</span><span class="sxs-lookup"><span data-stu-id="92c6f-169">This occurs when the `ClientCredentialType` property is set to `Windows` and the <xref:System.ServiceModel.MessageSecurityOverHttp.NegotiateServiceCredential%2A> property is set to `false`, as shown in the following code.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#1)]
 [!code-vb[C_DebuggingWindowsAuth#1](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#1)]  
  
 <span data-ttu-id="92c6f-170">Para corrigir, execute o serviço usando uma conta de computador de domínio, como serviço de rede, em um computador ingressado no domínio.</span><span class="sxs-lookup"><span data-stu-id="92c6f-170">To remedy, run the service using a Domain Machine account, such as Network Service, on a domain joined machine.</span></span>  
  
### <a name="delegation-requires-credential-negotiation"></a><span data-ttu-id="92c6f-171">A delegação requer negociação de credencial</span><span class="sxs-lookup"><span data-stu-id="92c6f-171">Delegation Requires Credential Negotiation</span></span>  
 <span data-ttu-id="92c6f-172">Para usar o protocolo de autenticação Kerberos com delegação, você deve implementar o protocolo Kerberos com a negociação de credencial (às vezes chamada de "multilocação" ou "multietapa" Kerberos).</span><span class="sxs-lookup"><span data-stu-id="92c6f-172">To use the Kerberos authentication protocol with delegation, you must implement the Kerberos protocol with credential negotiation (sometimes called "multi-leg" or "multi-step" Kerberos).</span></span> <span data-ttu-id="92c6f-173">Se você implementar a autenticação Kerberos sem negociação de credencial (às vezes chamada de Kerberos "One-shot" ou "single-perna"), uma exceção será lançada.</span><span class="sxs-lookup"><span data-stu-id="92c6f-173">If you implement Kerberos authentication without credential negotiation (sometimes called "one-shot" or "single-leg" Kerberos), an exception will be thrown.</span></span>  
  
 <span data-ttu-id="92c6f-174">Para implementar o Kerberos com a negociação de credencial, execute as seguintes etapas:</span><span class="sxs-lookup"><span data-stu-id="92c6f-174">To implement Kerberos with credential negotiation, do the following steps:</span></span>  
  
1. <span data-ttu-id="92c6f-175">Implemente a delegação definindo <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> como <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span><span class="sxs-lookup"><span data-stu-id="92c6f-175">Implement delegation by setting <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> to <xref:System.Security.Principal.TokenImpersonationLevel.Delegation>.</span></span>  
  
2. <span data-ttu-id="92c6f-176">Exigir negociação SSPI:</span><span class="sxs-lookup"><span data-stu-id="92c6f-176">Require SSPI negotiation:</span></span>  
  
    1. <span data-ttu-id="92c6f-177">Se você estiver usando associações padrão, defina a propriedade `NegotiateServiceCredential` como `true`.</span><span class="sxs-lookup"><span data-stu-id="92c6f-177">If you are using standard bindings, set the `NegotiateServiceCredential` property to `true`.</span></span>  
  
    2. <span data-ttu-id="92c6f-178">Se você estiver usando associações personalizadas, defina o atributo `AuthenticationMode` do elemento `Security` como `SspiNegotiated`.</span><span class="sxs-lookup"><span data-stu-id="92c6f-178">If you are using custom bindings, set the `AuthenticationMode` attribute of the `Security` element to `SspiNegotiated`.</span></span>  
  
3. <span data-ttu-id="92c6f-179">Exigir que a negociação SSPI use o Kerberos ao não permitir o uso do NTLM:</span><span class="sxs-lookup"><span data-stu-id="92c6f-179">Require the SSPI negotiation to use Kerberos by disallowing the use of NTLM:</span></span>  
  
    1. <span data-ttu-id="92c6f-180">Faça isso no código, com a seguinte instrução: `ChannelFactory.Credentials.Windows.AllowNtlm = false`</span><span class="sxs-lookup"><span data-stu-id="92c6f-180">Do this in code, with the following statement: `ChannelFactory.Credentials.Windows.AllowNtlm = false`</span></span>  
  
    2. <span data-ttu-id="92c6f-181">Ou você pode fazer isso no arquivo de configuração definindo o atributo `allowNtlm` como `false`.</span><span class="sxs-lookup"><span data-stu-id="92c6f-181">Or you can do this in the configuration file by setting the `allowNtlm` attribute to `false`.</span></span> <span data-ttu-id="92c6f-182">Esse atributo está contido no [\<> do Windows](../../../../docs/framework/configure-apps/file-schema/wcf/windows-of-clientcredentials-element.md).</span><span class="sxs-lookup"><span data-stu-id="92c6f-182">This attribute is contained in the [\<windows>](../../../../docs/framework/configure-apps/file-schema/wcf/windows-of-clientcredentials-element.md).</span></span>  
  
### <a name="ntlm-protocol"></a><span data-ttu-id="92c6f-183">Protocolo NTLM</span><span class="sxs-lookup"><span data-stu-id="92c6f-183">NTLM Protocol</span></span>  
  
#### <a name="negotiate-ssp-falls-back-to-ntlm-but-ntlm-is-disabled"></a><span data-ttu-id="92c6f-184">Negociar o SSP volta para o NTLM, mas o NTLM está desabilitado</span><span class="sxs-lookup"><span data-stu-id="92c6f-184">Negotiate SSP Falls Back to NTLM, but NTLM Is Disabled</span></span>  
 <span data-ttu-id="92c6f-185">A propriedade <xref:System.ServiceModel.Security.WindowsClientCredential.AllowNtlm%2A> é definida como `false`, o que faz com que o Windows Communication Foundation (WCF) faça um melhor esforço para gerar uma exceção se o NTLM for usado.</span><span class="sxs-lookup"><span data-stu-id="92c6f-185">The <xref:System.ServiceModel.Security.WindowsClientCredential.AllowNtlm%2A> property is set to `false`, which causes Windows Communication Foundation (WCF) to make a best-effort to throw an exception if NTLM is used.</span></span> <span data-ttu-id="92c6f-186">Observe que a definição dessa propriedade como `false` não pode impedir que credenciais NTLM sejam enviadas pela conexão.</span><span class="sxs-lookup"><span data-stu-id="92c6f-186">Note that setting this property to `false` may not prevent NTLM credentials from being sent over the wire.</span></span>  
  
 <span data-ttu-id="92c6f-187">O seguinte mostra como desabilitar o fallback para NTLM.</span><span class="sxs-lookup"><span data-stu-id="92c6f-187">The following shows how to disable fallback to NTLM.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#4](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#4)]
 [!code-vb[C_DebuggingWindowsAuth#4](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#4)]  
  
#### <a name="ntlm-logon-fails"></a><span data-ttu-id="92c6f-188">Falha no logon NTLM</span><span class="sxs-lookup"><span data-stu-id="92c6f-188">NTLM Logon Fails</span></span>  
 <span data-ttu-id="92c6f-189">As credenciais do cliente não são válidas no serviço.</span><span class="sxs-lookup"><span data-stu-id="92c6f-189">The client credentials are not valid on the service.</span></span> <span data-ttu-id="92c6f-190">Verifique se o nome de usuário e a senha estão definidos corretamente e correspondem a uma conta que é conhecida pelo computador em que o serviço está sendo executado.</span><span class="sxs-lookup"><span data-stu-id="92c6f-190">Check that the user name and password are correctly set and correspond to an account that is known to the computer where the service is running.</span></span> <span data-ttu-id="92c6f-191">O NTLM usa as credenciais especificadas para fazer logon no computador do serviço.</span><span class="sxs-lookup"><span data-stu-id="92c6f-191">NTLM uses the specified credentials to log on to the service's computer.</span></span> <span data-ttu-id="92c6f-192">Embora as credenciais possam ser válidas no computador em que o cliente está em execução, esse logon falhará se as credenciais não forem válidas no computador do serviço.</span><span class="sxs-lookup"><span data-stu-id="92c6f-192">While the credentials may be valid on the computer where the client is running, this logon will fail if the credentials are not valid on the service's computer.</span></span>  
  
#### <a name="anonymous-ntlm-logon-occurs-but-anonymous-logons-are-disabled-by-default"></a><span data-ttu-id="92c6f-193">O logon anônimo do NTLM ocorre, mas logons anônimos são desabilitados por padrão</span><span class="sxs-lookup"><span data-stu-id="92c6f-193">Anonymous NTLM Logon Occurs, but Anonymous Logons Are Disabled by Default</span></span>  
 <span data-ttu-id="92c6f-194">Ao criar um cliente, a propriedade <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> é definida como <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, conforme mostrado no exemplo a seguir, mas, por padrão, o servidor não permite logons anônimos.</span><span class="sxs-lookup"><span data-stu-id="92c6f-194">When creating a client, the <xref:System.ServiceModel.Security.WindowsClientCredential.AllowedImpersonationLevel%2A> property is set to <xref:System.Security.Principal.TokenImpersonationLevel.Anonymous>, as shown in the following example, but by default the server disallows anonymous logons.</span></span> <span data-ttu-id="92c6f-195">Isso ocorre porque o valor padrão da propriedade <xref:System.ServiceModel.Security.WindowsServiceCredential.AllowAnonymousLogons%2A> da classe <xref:System.ServiceModel.Security.WindowsServiceCredential> é `false`.</span><span class="sxs-lookup"><span data-stu-id="92c6f-195">This occurs because the default value of the <xref:System.ServiceModel.Security.WindowsServiceCredential.AllowAnonymousLogons%2A> property of the <xref:System.ServiceModel.Security.WindowsServiceCredential> class is `false`.</span></span>  
  
 <span data-ttu-id="92c6f-196">O seguinte código de cliente tenta habilitar logons anônimos (Observe que a propriedade padrão é `Identification`).</span><span class="sxs-lookup"><span data-stu-id="92c6f-196">The following client code attempts to enable anonymous logons (note that the default property is `Identification`).</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#5](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#5)]
 [!code-vb[C_DebuggingWindowsAuth#5](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#5)]  
  
 <span data-ttu-id="92c6f-197">O código de serviço a seguir altera o padrão para habilitar logons anônimos pelo servidor.</span><span class="sxs-lookup"><span data-stu-id="92c6f-197">The following service code changes the default to enable anonymous logons by the server.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#6](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#6)]
 [!code-vb[C_DebuggingWindowsAuth#6](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#6)]  
  
 <span data-ttu-id="92c6f-198">Para obter mais informações sobre representação, consulte [delegação e representação](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md).</span><span class="sxs-lookup"><span data-stu-id="92c6f-198">For more information about impersonation, see [Delegation and Impersonation](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md).</span></span>  
  
 <span data-ttu-id="92c6f-199">Como alternativa, o cliente está sendo executado como um serviço do Windows, usando o sistema de conta interno.</span><span class="sxs-lookup"><span data-stu-id="92c6f-199">Alternatively, the client is running as a Windows service, using the built-in account SYSTEM.</span></span>  
  
### <a name="other-problems"></a><span data-ttu-id="92c6f-200">Outros Problemas</span><span class="sxs-lookup"><span data-stu-id="92c6f-200">Other Problems</span></span>  
  
#### <a name="client-credentials-are-not-set-correctly"></a><span data-ttu-id="92c6f-201">As credenciais do cliente não estão definidas corretamente</span><span class="sxs-lookup"><span data-stu-id="92c6f-201">Client Credentials Are Not Set Correctly</span></span>  
 <span data-ttu-id="92c6f-202">A autenticação do Windows usa a instância de <xref:System.ServiceModel.Security.WindowsClientCredential> retornada pela propriedade <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> da classe <xref:System.ServiceModel.ClientBase%601>, não a <xref:System.ServiceModel.Security.UserNamePasswordClientCredential>.</span><span class="sxs-lookup"><span data-stu-id="92c6f-202">Windows authentication uses the <xref:System.ServiceModel.Security.WindowsClientCredential> instance returned by the <xref:System.ServiceModel.ClientBase%601.ClientCredentials%2A> property of the <xref:System.ServiceModel.ClientBase%601> class, not the <xref:System.ServiceModel.Security.UserNamePasswordClientCredential>.</span></span> <span data-ttu-id="92c6f-203">Veja a seguir um exemplo incorreto.</span><span class="sxs-lookup"><span data-stu-id="92c6f-203">The following shows an incorrect example.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#2)]
 [!code-vb[C_DebuggingWindowsAuth#2](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#2)]  
  
 <span data-ttu-id="92c6f-204">O exemplo a seguir mostra o correto.</span><span class="sxs-lookup"><span data-stu-id="92c6f-204">The following shows the correct example.</span></span>  
  
 [!code-csharp[C_DebuggingWindowsAuth#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/c_debuggingwindowsauth/cs/source.cs#3)]
 [!code-vb[C_DebuggingWindowsAuth#3](../../../../samples/snippets/visualbasic/VS_Snippets_CFX/c_debuggingwindowsauth/vb/source.vb#3)]  
  
#### <a name="sspi-is-not-available"></a><span data-ttu-id="92c6f-205">SSPI não está disponível</span><span class="sxs-lookup"><span data-stu-id="92c6f-205">SSPI Is Not Available</span></span>  
 <span data-ttu-id="92c6f-206">Os seguintes sistemas operacionais não dão suporte à autenticação do Windows quando usados como um servidor: [!INCLUDE[wxp](../../../../includes/wxp-md.md)] Home Edition, [!INCLUDE[wxp](../../../../includes/wxp-md.md)] Media Center Edition e Windows Vista página inicial.</span><span class="sxs-lookup"><span data-stu-id="92c6f-206">The following operating systems do not support Windows authentication when used as a server: [!INCLUDE[wxp](../../../../includes/wxp-md.md)] Home Edition, [!INCLUDE[wxp](../../../../includes/wxp-md.md)] Media Center Edition, and Windows Vista Home editions.</span></span>  
  
#### <a name="developing-and-deploying-with-different-identities"></a><span data-ttu-id="92c6f-207">Desenvolvendo e implantando com identidades diferentes</span><span class="sxs-lookup"><span data-stu-id="92c6f-207">Developing and Deploying with Different Identities</span></span>  
 <span data-ttu-id="92c6f-208">Se você desenvolver seu aplicativo em um computador e implantá-lo em outro e usar tipos de conta diferentes para autenticar em cada computador, poderá ocorrer um comportamento diferente.</span><span class="sxs-lookup"><span data-stu-id="92c6f-208">If you develop your application on one machine, and deploy on another, and use different account types to authenticate on each machine, you may experience different behavior.</span></span> <span data-ttu-id="92c6f-209">Por exemplo, suponha que você desenvolva seu aplicativo em um computador Windows XP Pro usando o modo de autenticação `SSPI Negotiated`.</span><span class="sxs-lookup"><span data-stu-id="92c6f-209">For example, suppose you develop your application on a Windows XP Pro machine using the `SSPI Negotiated` authentication mode.</span></span> <span data-ttu-id="92c6f-210">Se você usar uma conta de usuário local para autenticar com o, o protocolo NTLM será usado.</span><span class="sxs-lookup"><span data-stu-id="92c6f-210">If you use a local user account to authenticate with, then NTLM protocol will be used.</span></span> <span data-ttu-id="92c6f-211">Depois que o aplicativo é desenvolvido, você implanta o serviço em um computador com Windows Server 2003 em que ele é executado em uma conta de domínio.</span><span class="sxs-lookup"><span data-stu-id="92c6f-211">Once the application is developed, you deploy the service to a Windows Server 2003 machine where it runs under a domain account.</span></span> <span data-ttu-id="92c6f-212">Neste ponto, o cliente não poderá autenticar o serviço, pois ele usará o Kerberos e um controlador de domínio.</span><span class="sxs-lookup"><span data-stu-id="92c6f-212">At this point the client will not be able to authenticate the service because it will be using Kerberos and a domain controller.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="92c6f-213">Consulte também</span><span class="sxs-lookup"><span data-stu-id="92c6f-213">See also</span></span>

- <xref:System.ServiceModel.Security.WindowsClientCredential>
- <xref:System.ServiceModel.Security.WindowsServiceCredential>
- <xref:System.ServiceModel.Security.WindowsClientCredential>
- <xref:System.ServiceModel.ClientBase%601>
- [<span data-ttu-id="92c6f-214">Delegação e representação</span><span class="sxs-lookup"><span data-stu-id="92c6f-214">Delegation and Impersonation</span></span>](../../../../docs/framework/wcf/feature-details/delegation-and-impersonation-with-wcf.md)
- [<span data-ttu-id="92c6f-215">Cenários sem suporte</span><span class="sxs-lookup"><span data-stu-id="92c6f-215">Unsupported Scenarios</span></span>](../../../../docs/framework/wcf/feature-details/unsupported-scenarios.md)
