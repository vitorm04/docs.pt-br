---
title: Gerenciando o contexto do serviço de dados (WCF Data Services)
ms.date: 03/30/2017
ms.assetid: 15b19d09-7de7-4638-9556-6ef396cc45ec
ms.openlocfilehash: e67f7280bc85c7577f960707659890f59470e535
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 09/24/2020
ms.locfileid: "91194291"
---
# <a name="managing-the-data-service-context-wcf-data-services"></a>Gerenciando o contexto do serviço de dados (WCF Data Services)

A classe <xref:System.Data.Services.Client.DataServiceContext> encapsula as operações que têm suporte em um serviço de dados especificado. Embora os serviços OData sejam sem estado, o contexto não é. Portanto, você pode usar a <xref:System.Data.Services.Client.DataServiceContext> classe para manter o estado no cliente entre as interações com o serviço de dados para dar suporte a recursos como o gerenciamento de alterações. Essa classe também gerencia identidades e rastreia alterações.  
  
## <a name="merge-options-and-identity-resolution"></a>Opções de mesclagem e resolução de identidade  

 Quando um <xref:System.Data.Services.Client.DataServiceQuery%601> é executado, as entidades no feed de resposta são materializadas em objetos. Para obter mais informações, consulte [materialização de objeto](object-materialization-wcf-data-services.md). A maneira na qual as entradas em uma mensagem de resposta são materializadas em objetos é executada com base na resolução de identidade e depende da opção de mesclagem sob a qual a consulta foi executada. Quando várias consultas ou solicitações de carregamento são executadas no escopo de um único <xref:System.Data.Services.Client.DataServiceContext> , o cliente WCF Data Services controla apenas uma única instância de um objeto que tem um valor de chave específico. Essa chave, que é usada para executar a resolução de identidade, identifica exclusivamente uma entidade.  
  
 Por padrão, o cliente materializa apenas uma entrada no feed de resposta em um objeto para entidades que ainda não estão sendo controladas pelo <xref:System.Data.Services.Client.DataServiceContext> . Isso significa que as alterações em objetos que já estão no cache não são substituídas. Esse comportamento é controlado pela especificação de um <xref:System.Data.Services.Client.MergeOption> valor para consultas e operações de carregamento. Essa opção é especificada definindo a <xref:System.Data.Services.Client.DataServiceContext.MergeOption%2A> propriedade no <xref:System.Data.Services.Client.DataServiceContext> . O valor da opção de mesclagem padrão é <xref:System.Data.Services.Client.MergeOption.AppendOnly> . Isso apenas materializa objetos para entidades que ainda não estão sendo acompanhadas, o que significa que os objetos existentes não são substituídos. Outra maneira de impedir que as alterações em objetos no cliente sejam substituídas por atualizações do serviço de dados é especificar <xref:System.Data.Services.Client.MergeOption.PreserveChanges> . Quando você especifica <xref:System.Data.Services.Client.MergeOption.OverwriteChanges> , os valores de objetos no cliente são substituídos pelos valores mais recentes das entradas no feed de resposta, mesmo que as alterações já tenham sido feitas nesses objetos. Quando uma <xref:System.Data.Services.Client.MergeOption.NoTracking> opção de mesclagem é usada, o <xref:System.Data.Services.Client.DataServiceContext> não pode enviar alterações feitas em objetos de cliente para o serviço de dados. Com essa opção, as alterações sempre são substituídas por valores do serviço de dados.  
  
## <a name="managing-concurrency"></a>Gerenciamento de Simultaneidade  

 O OData dá suporte à simultaneidade otimista que permite que o serviço de dados detecte conflitos de atualização. O provedor de serviços de dados pode ser configurado de forma que o serviço de dados verifique se há alterações nas entidades usando um token de simultaneidade. Esse token inclui uma ou mais propriedades de um tipo de entidade que são validadas pelo serviço de dados para determinar se um recurso foi alterado. Os tokens de simultaneidade, que são incluídos no cabeçalho eTag das solicitações e respostas do serviço de dados, são gerenciados para você pelo cliente do WCF Data Services. Para obter mais informações, consulte [atualizando o serviço de dados](updating-the-data-service-wcf-data-services.md).  
  
 O <xref:System.Data.Services.Client.DataServiceContext> controla as alterações feitas nos objetos que foram relatados manualmente usando <xref:System.Data.Services.Client.DataServiceContext.AddObject%2A> , <xref:System.Data.Services.Client.DataServiceContext.UpdateObject%2A> , e <xref:System.Data.Services.Client.DataServiceContext.DeleteObject%2A> , ou por um <xref:System.Data.Services.Client.DataServiceCollection%601> . Quando o <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> método é chamado, o cliente envia as alterações de volta para o serviço de dados. <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> pode falhar quando as alterações de dados no cliente entram em conflito com as alterações no serviço de dados. Quando isso ocorrer, você deverá consultar o recurso de entidade novamente para receber os dados de atualização. Para substituir as alterações no serviço de dados, execute a consulta usando a <xref:System.Data.Services.Client.MergeOption.PreserveChanges> opção de mesclagem. Quando você chama <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> novamente, as alterações preservadas no cliente são persistidas no serviço de dados, desde que outras alterações ainda não tenham sido feitas no recurso no serviço de dados.  
  
## <a name="saving-changes"></a>Salvando alterações  

 As alterações são rastreadas na <xref:System.Data.Services.Client.DataServiceContext> instância, mas não são enviadas ao servidor imediatamente. Depois de concluir as alterações necessárias para uma atividade especificada, chame <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> para enviar todas as alterações para o serviço de dados. Um <xref:System.Data.Services.Client.DataServiceResponse> objeto é retornado depois que a <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> operação é concluída. O <xref:System.Data.Services.Client.DataServiceResponse> objeto inclui uma sequência de <xref:System.Data.Services.Client.OperationResponse> objetos que, por sua vez, contêm uma sequência <xref:System.Data.Services.Client.EntityDescriptor> de <xref:System.Data.Services.Client.LinkDescriptor> instâncias ou que representam as alterações persistentes ou tentadas. Quando uma entidade é criada ou modificada no serviço de dados, o <xref:System.Data.Services.Client.EntityDescriptor> inclui uma referência à entidade atualizada, incluindo quaisquer valores de propriedade gerados pelo servidor, como o `ProductID` valor gerado no exemplo anterior. A biblioteca de cliente atualiza automaticamente o .NET Framework objeto para ter esses novos valores.  
  
 Para operações de inserção e atualização bem-sucedidas, a propriedade State do <xref:System.Data.Services.Client.EntityDescriptor> <xref:System.Data.Services.Client.LinkDescriptor> objeto ou associado à operação é definida como <xref:System.Data.Services.Client.EntityStates.Unchanged> e os novos valores são mesclados usando <xref:System.Data.Services.Client.MergeOption.OverwriteChanges> . Quando uma operação de inserção, atualização ou exclusão falha no serviço de dados, o estado da entidade permanece o mesmo que era antes de <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> ser chamado, e a <xref:System.Data.Services.Client.OperationResponse.Error%2A> propriedade de <xref:System.Data.Services.Client.OperationResponse> é definida como um <xref:System.Data.Services.Client.DataServiceRequestException> que contém informações sobre o erro. Para obter mais informações, consulte [atualizando o serviço de dados](updating-the-data-service-wcf-data-services.md).  
  
### <a name="setting-the-http-method-for-updates"></a>Configurando o método HTTP para atualizações  

 Por padrão, a biblioteca de cliente do .NET Framework envia atualizações para entidades existentes como solicitações de MESCLAgem. Uma solicitação de MESCLAgem atualiza as propriedades selecionadas da entidade; no entanto, o cliente sempre inclui todas as propriedades na solicitação de MESCLAgem, até mesmo propriedades que não foram alteradas. O protocolo OData também dá suporte ao envio de solicitações PUT para atualizar entidades. Em uma solicitação PUT, uma entidade existente é basicamente substituída por uma nova instância da entidade com valores de Propriedade do cliente. Para usar solicitações PUT, defina o <xref:System.Data.Services.Client.SaveChangesOptions.ReplaceOnUpdate> sinalizador na <xref:System.Data.Services.Client.SaveChangesOptions> enumeração ao chamar <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> .  
  
> [!NOTE]
> Uma solicitação PUT terá um comportamento diferente de uma solicitação MERGE quando o cliente não souber sobre todas as propriedades da entidade. Isso pode ocorrer ao projetar um tipo de entidade em um novo tipo no cliente. Isso também pode ocorrer quando novas propriedades foram adicionadas à entidade no modelo de dados de serviço e a <xref:System.Data.Services.Client.DataServiceContext.IgnoreMissingProperties%2A> propriedade em <xref:System.Data.Services.Client.DataServiceContext> é definida como `true` para ignorar esses erros de mapeamento de cliente. Nesses casos, uma solicitação PUT redefinirá todas as propriedades que são desconhecidas para o cliente para seus valores padrão.  
  
### <a name="post-tunneling"></a>PÓS-túnel  

 Por padrão, a biblioteca de cliente envia solicitações de criação, leitura, atualização e exclusão para um serviço OData usando os métodos HTTP correspondentes de POST, GET, PUT/MERGE/PATCH e DELETE. Isso mantém os princípios básicos da REST (transferência de estado de reapresentação). No entanto, nem toda implementação de servidor Web dá suporte ao conjunto completo de métodos HTTP. Em alguns casos, os métodos com suporte podem ser restritos a apenas GET e POST. Isso pode acontecer quando um intermediário, como um firewall, bloqueia solicitações com determinados métodos. Como os métodos GET e POST são suportados com mais frequência, o OData prescreve uma maneira de executar qualquer método HTTP sem suporte usando uma solicitação POST. Conhecido como *encapsulamento de método* ou *pós-túnel*, isso permite que um cliente envie uma solicitação post com o método real especificado no `X-HTTP-Method` cabeçalho personalizado. Para habilitar o encapsulamento posterior para solicitações, defina a <xref:System.Data.Services.Client.DataServiceContext.UsePostTunneling%2A> Propriedade na <xref:System.Data.Services.Client.DataServiceContext> instância como `true` .  
  
## <a name="see-also"></a>Veja também

- [Biblioteca de cliente do WCF Data Services](wcf-data-services-client-library.md)
- [Atualizar o serviço de dados](updating-the-data-service-wcf-data-services.md)
- [Operações assíncronas](asynchronous-operations-wcf-data-services.md)
- [Operações de envio em lote](batching-operations-wcf-data-services.md)
