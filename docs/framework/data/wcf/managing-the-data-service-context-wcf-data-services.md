---
title: Gerenciando o contexto do serviço de dados (WCF Data Services)
ms.date: 03/30/2017
ms.assetid: 15b19d09-7de7-4638-9556-6ef396cc45ec
ms.openlocfilehash: 621887f2814127c7c6800fecc9ade1e161db46e0
ms.sourcegitcommit: f348c84443380a1959294cdf12babcb804cfa987
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 11/12/2019
ms.locfileid: "73975208"
---
# <a name="managing-the-data-service-context-wcf-data-services"></a>Gerenciando o contexto do serviço de dados (WCF Data Services)
A classe <xref:System.Data.Services.Client.DataServiceContext> encapsula as operações que têm suporte em um serviço de dados especificado. Embora os serviços OData sejam sem estado, o contexto não é. Portanto, você pode usar a classe <xref:System.Data.Services.Client.DataServiceContext> para manter o estado no cliente entre as interações com o serviço de dados a fim de dar suporte a recursos como o gerenciamento de alterações. Essa classe também gerencia identidades e rastreia alterações.  
  
## <a name="merge-options-and-identity-resolution"></a>Opções de mesclagem e resolução de identidade  
 Quando um <xref:System.Data.Services.Client.DataServiceQuery%601> é executado, as entidades no feed de resposta são materializadas em objetos. Para obter mais informações, consulte [materialização de objeto](object-materialization-wcf-data-services.md). A maneira na qual as entradas em uma mensagem de resposta são materializadas em objetos é executada com base na resolução de identidade e depende da opção de mesclagem sob a qual a consulta foi executada. Quando várias consultas ou solicitações de carregamento são executadas no escopo de um único <xref:System.Data.Services.Client.DataServiceContext>, o cliente [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)] rastreia apenas uma única instância de um objeto que tem um valor de chave específico. Essa chave, que é usada para executar a resolução de identidade, identifica exclusivamente uma entidade.  
  
 Por padrão, o cliente materializa apenas uma entrada no feed de resposta em um objeto para entidades que ainda não estão sendo controladas pelo <xref:System.Data.Services.Client.DataServiceContext>. Isso significa que as alterações em objetos que já estão no cache não são substituídas. Esse comportamento é controlado pela especificação de um valor de <xref:System.Data.Services.Client.MergeOption> para consultas e operações de carregamento. Essa opção é especificada definindo a propriedade <xref:System.Data.Services.Client.DataServiceContext.MergeOption%2A> no <xref:System.Data.Services.Client.DataServiceContext>. O valor padrão da opção de mesclagem é <xref:System.Data.Services.Client.MergeOption.AppendOnly>. Isso apenas materializa objetos para entidades que ainda não estão sendo acompanhadas, o que significa que os objetos existentes não são substituídos. Outra maneira de impedir que as alterações em objetos no cliente sejam substituídas por atualizações do serviço de dados é especificar <xref:System.Data.Services.Client.MergeOption.PreserveChanges>. Quando você especifica <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>, os valores de objetos no cliente são substituídos pelos valores mais recentes das entradas no feed de resposta, mesmo que as alterações já tenham sido feitas nesses objetos. Quando uma opção de mesclagem de <xref:System.Data.Services.Client.MergeOption.NoTracking> é usada, o <xref:System.Data.Services.Client.DataServiceContext> não pode enviar alterações feitas em objetos de cliente para o serviço de dados. Com essa opção, as alterações sempre são substituídas por valores do serviço de dados.  
  
## <a name="managing-concurrency"></a>Gerenciando a simultaneidade  
 O OData dá suporte à simultaneidade otimista que permite que o serviço de dados detecte conflitos de atualização. O provedor de serviços de dados pode ser configurado de forma que o serviço de dados verifique se há alterações nas entidades usando um token de simultaneidade. Esse token inclui uma ou mais propriedades de um tipo de entidade que são validadas pelo serviço de dados para determinar se um recurso foi alterado. Os tokens de simultaneidade, que são incluídos no cabeçalho eTag das solicitações e respostas do serviço de dados, são gerenciados para você pelo cliente do [!INCLUDE[ssAstoria](../../../../includes/ssastoria-md.md)]. Para obter mais informações, consulte [atualizando o serviço de dados](updating-the-data-service-wcf-data-services.md).  
  
 O <xref:System.Data.Services.Client.DataServiceContext> controla as alterações feitas em objetos que foram relatados manualmente usando <xref:System.Data.Services.Client.DataServiceContext.AddObject%2A>, <xref:System.Data.Services.Client.DataServiceContext.UpdateObject%2A>e <xref:System.Data.Services.Client.DataServiceContext.DeleteObject%2A>ou por um <xref:System.Data.Services.Client.DataServiceCollection%601>. Quando o método <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> é chamado, o cliente envia as alterações de volta para o serviço de dados. <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> pode falhar quando as alterações de dados no cliente entram em conflito com as alterações no serviço de dados. Quando isso ocorrer, você deverá consultar o recurso de entidade novamente para receber os dados de atualização. Para substituir as alterações no serviço de dados, execute a consulta usando a opção <xref:System.Data.Services.Client.MergeOption.PreserveChanges> Merge. Quando você chama <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> novamente, as alterações preservadas no cliente são mantidas no serviço de dados, desde que outras alterações ainda não tenham sido feitas no recurso no serviço de dados.  
  
## <a name="saving-changes"></a>Salvando alterações  
 As alterações são controladas na instância <xref:System.Data.Services.Client.DataServiceContext>, mas não são enviadas ao servidor imediatamente. Depois de concluir as alterações necessárias para uma atividade especificada, chame <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> para enviar todas as alterações para o serviço de dados. Um objeto <xref:System.Data.Services.Client.DataServiceResponse> é retornado após a conclusão da operação de <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>. O objeto <xref:System.Data.Services.Client.DataServiceResponse> inclui uma sequência de objetos <xref:System.Data.Services.Client.OperationResponse> que, por sua vez, contêm uma sequência de instâncias <xref:System.Data.Services.Client.EntityDescriptor> ou <xref:System.Data.Services.Client.LinkDescriptor> que representam as alterações persistentes ou tentadas. Quando uma entidade é criada ou modificada no serviço de dados, a <xref:System.Data.Services.Client.EntityDescriptor> inclui uma referência à entidade atualizada, incluindo quaisquer valores de propriedade gerados pelo servidor, como o valor de `ProductID` gerado no exemplo anterior. A biblioteca de cliente atualiza automaticamente o .NET Framework objeto para ter esses novos valores.  
  
 Para operações de inserção e atualização bem-sucedidas, a propriedade State do objeto <xref:System.Data.Services.Client.EntityDescriptor> ou <xref:System.Data.Services.Client.LinkDescriptor> associado à operação é definida como <xref:System.Data.Services.Client.EntityStates.Unchanged> e os novos valores são mesclados usando <xref:System.Data.Services.Client.MergeOption.OverwriteChanges>. Quando uma operação de inserção, atualização ou exclusão falha no serviço de dados, o estado da entidade permanece o mesmo que era antes de <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A> ser chamado, e a propriedade <xref:System.Data.Services.Client.OperationResponse.Error%2A> da <xref:System.Data.Services.Client.OperationResponse> é definida como um <xref:System.Data.Services.Client.DataServiceRequestException> que contém informações sobre o erro. Para obter mais informações, consulte [atualizando o serviço de dados](updating-the-data-service-wcf-data-services.md).  
  
### <a name="setting-the-http-method-for-updates"></a>Configurando o método HTTP para atualizações  
 Por padrão, a biblioteca de cliente do .NET Framework envia atualizações para entidades existentes como solicitações de MESCLAgem. Uma solicitação de MESCLAgem atualiza as propriedades selecionadas da entidade; no entanto, o cliente sempre inclui todas as propriedades na solicitação de MESCLAgem, até mesmo propriedades que não foram alteradas. O protocolo OData também dá suporte ao envio de solicitações PUT para atualizar entidades. Em uma solicitação PUT, uma entidade existente é basicamente substituída por uma nova instância da entidade com valores de Propriedade do cliente. Para usar solicitações PUT, defina o sinalizador <xref:System.Data.Services.Client.SaveChangesOptions.ReplaceOnUpdate> na enumeração <xref:System.Data.Services.Client.SaveChangesOptions> ao chamar <xref:System.Data.Services.Client.DataServiceContext.SaveChanges%2A>.  
  
> [!NOTE]
> Uma solicitação PUT terá um comportamento diferente de uma solicitação MERGE quando o cliente não souber sobre todas as propriedades da entidade. Isso pode ocorrer ao projetar um tipo de entidade em um novo tipo no cliente. Também pode ocorrer quando novas propriedades forem adicionadas à entidade no modelo de dados de serviço e a propriedade <xref:System.Data.Services.Client.DataServiceContext.IgnoreMissingProperties%2A> na <xref:System.Data.Services.Client.DataServiceContext> estiver definida como `true` para ignorar esses erros de mapeamento de cliente. Nesses casos, uma solicitação PUT redefinirá todas as propriedades que são desconhecidas para o cliente para seus valores padrão.  
  
### <a name="post-tunneling"></a>PÓS-túnel  
 Por padrão, a biblioteca de cliente envia solicitações de criação, leitura, atualização e exclusão para um serviço OData usando os métodos HTTP correspondentes de POST, GET, PUT/MERGE/PATCH e DELETE. Isso mantém os princípios básicos da REST (transferência de estado de reapresentação). No entanto, nem toda implementação de servidor Web dá suporte ao conjunto completo de métodos HTTP. Em alguns casos, os métodos com suporte podem ser restritos a apenas GET e POST. Isso pode acontecer quando um intermediário, como um firewall, bloqueia solicitações com determinados métodos. Como os métodos GET e POST são suportados com mais frequência, o OData prescreve uma maneira de executar qualquer método HTTP sem suporte usando uma solicitação POST. Conhecido como *túnel de método* ou *encapsulamento posterior*, isso permite que um cliente envie uma solicitação post com o método real especificado no cabeçalho de `X-HTTP-Method` personalizado. Para habilitar o encapsulamento posterior para solicitações, defina a propriedade <xref:System.Data.Services.Client.DataServiceContext.UsePostTunneling%2A> na instância de <xref:System.Data.Services.Client.DataServiceContext> como `true`.  
  
## <a name="see-also"></a>Consulte também

- [WCF Data Services Client Library](wcf-data-services-client-library.md) (Biblioteca de clientes do WCF Data Services)
- [Atualizando o serviço de dados](updating-the-data-service-wcf-data-services.md)
- [Operações assíncronas](asynchronous-operations-wcf-data-services.md)
- [Operações de envio em lote](batching-operations-wcf-data-services.md)
